<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Papadums Invoice — Live Multi-User</title>
<style>
body{font-family:Arial,sans-serif;background:#f4f6f8;margin:0;padding:16px;}
.app{display:flex;gap:16px;align-items:flex-start;}
.controls{width:360px;background:#fff;padding:12px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.08);}
label{display:block;margin-top:8px;font-size:13px;}
input[type=text],input[type=number],select{width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;margin-top:4px;box-sizing:border-box;}
button{margin-top:6px;padding:8px 12px;background:#0572e6;border:none;color:#fff;border-radius:6px;cursor:pointer;}
button.ghost{background:#fff;color:#222;border:1px solid #ddd;}
.receipt-wrap{background:#fff;padding:12px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.08);}
.receipt{width:calc(58mm*3.78px);padding:6px;background:#fff;color:#000;}
.center{text-align:center;}
.right{text-align:right;}
.small{font-size:11px;}
.items{margin-top:6px;}
.items .row{display:grid;grid-template-columns:1fr 60px 36px 60px;align-items:center;padding:4px 0;border-bottom:1px dashed #ddd;font-size:12px;}
.items .row.header{font-weight:700;border-bottom:1px solid #000;}
.totals{margin-top:6px;font-size:13px;}
.totals .line{display:flex;justify-content:space-between;padding:2px 0;}
#searchResults{border:1px solid #ccc;max-height:160px;overflow-y:auto;display:none;background:#fff;position:absolute;z-index:1000;}
#searchResults div{padding:6px 8px;cursor:pointer;}
#searchResults div:hover{background:#eee;}
@media print{.controls{display:none}.receipt{box-shadow:none;border-radius:0;margin:0}}
.header-title{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:700;font-size:12px;}
#tableDashboard button{padding:6px 10px;font-size:13px;}
#syncing{position:fixed;bottom:10px;right:10px;background:rgba(255,102,0,0.9);color:#fff;padding:6px 10px;border-radius:8px;font-size:13px;font-family:sans-serif;display:none;}
</style>
</head>
<body>
<div class="app">
  <div class="controls">
    <h3>Table Dashboard</h3>
    <div id="tableDashboard" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px;"></div>

    <label>Bàn Number
      <select id="tableNumber"></select>
    </label>

    <label>Search Product
      <input id="productSearch" type="text" placeholder="Type product name..." autocomplete="off" style="font-size:14px;padding:10px;">
    </label>
    <div id="searchResults"></div>

    <label>Price <input id="itemPrice" type="number"></label>
    <label>Qty <input id="itemQty" type="number" value="1" min="1"></label>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="addBtn">Add Item</button>
      <button id="clearBtn" class="ghost">Clear Items</button>
    </div>

    <label>Bill Number <input id="billNumber" type="text" value="HD001691"></label>
    <label>Time In <input id="timeIn" type="text"></label>
    <label>Time Out <input id="timeOut" type="text"></label>
    <label>VAT % <input id="vatPercent" type="number" value="8"></label>
    <label>Discount <input id="discount" type="number" value="0"></label>
    <hr>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button id="printBtn">Print</button>
      <button id="downloadBtn" class="ghost">Download PDF</button>
    </div>
  </div>

  <div class="receipt-wrap">
    <div class="receipt" id="invoice">
      <div class="center" style="margin-bottom:6px;">
        <div class="header-title">PAPADUMS INDIAN CUISINE</div>
        <div class="small"><b>Address:</b> 35 Tran Hung Dao, District 1, HCM</div>
        <div class="small"><b>Phone:</b> 0946 024 520</div>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
        <div style="border:1px solid #000;padding:4px;border-radius:8px;font-size:12px;font-weight:700">
          <span id="tableLabel">Bàn 1</span>
        </div>
        <div style="text-align:center">
          <div style="font-weight:700">INVOICE</div>
          <div class="small" style="font-weight:700">Bill number: <span id="billLabel">HD001691</span></div>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;margin-top:6px;font-size:12px">
        <div>Time in: <div class="small" id="timeInLabel"></div></div>
        <div style="text-align:right">Time out: <div class="small" id="timeOutLabel"></div></div>
      </div>

      <div class="items" id="itemsList">
        <div class="row header"><div>Item Name</div><div class="right">Price</div><div class="right">Qty</div><div class="right">Amount</div></div>
      </div>

      <div style="border-top:1px solid #000;margin-top:6px;padding-top:6px">
        <div class="totals">
          <div class="line"><div>Total Price:</div><div id="totalPrice" class="right" style="font-weight:700">0</div></div>
          <div class="line"><div>Discount:</div><div id="discountLabel" class="right">0</div></div>
          <div class="line"><div>VAT <span id="vatPctLabel">8</span>%:</div><div id="vatAmount" class="right">0</div></div>
          <div class="line" style="font-size:15px"><div style="font-weight:700">Total:</div><div id="grandTotal" class="right" style="font-weight:700">0</div></div>
        </div>
      </div>

      <div class="center" style="margin-top:8px;">
        <div class="header-title">PAPADUMS INDIAN CUISINE</div>
        <div class="small"><b>Address:</b> 35 Tran Hung Dao, District 1, HCM</div>
        <div class="small"><b>Phone:</b> 0946 024 520</div>
        <div class="small">WiFi: <b>Papadums Indian Cuisine 5G</b></div>
        <div class="small">Password: <b>everyday</b></div>
      </div>

      <div class="center" style="margin-top:6px;">
        <canvas id="qrImg" width="80" height="80"></canvas>
        <div class="small" style="margin-top:4px;">Invoice includes VAT</div>
      </div>
    </div>
  </div>
</div>

<div id="syncing">⟳ Syncing...</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot, collection, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBqkX9NYJD3SM8YcXf73P4IY9eT72KIyIw",
  authDomain: "invoiceapp-8026d.firebaseapp.com",
  projectId: "invoiceapp-8026d",
  storageBucket: "invoiceapp-8026d.firebasestorage.app",
  messagingSenderId: "871292464773",
  appId: "1:871292464773:web:8f288ebc5f9db3352243ec"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// DOM Elements
const syncing = document.getElementById("syncing");
const tableSelect = document.getElementById("tableNumber");
const tableDashboard = document.getElementById("tableDashboard");
const itemsList = document.getElementById("itemsList");
const totalPrice = document.getElementById("totalPrice");
const discount = document.getElementById("discount");
const discountLabel = document.getElementById("discountLabel");
const vatPercent = document.getElementById("vatPercent");
const vatPctLabel = document.getElementById("vatPctLabel");
const vatAmount = document.getElementById("vatAmount");
const grandTotal = document.getElementById("grandTotal");
const tableLabel = document.getElementById("tableLabel");
const timeIn = document.getElementById("timeIn");
const timeOut = document.getElementById("timeOut");
const timeInLabel = document.getElementById("timeInLabel");
const timeOutLabel = document.getElementById("timeOutLabel");
const productSearch = document.getElementById("productSearch");
const itemPrice = document.getElementById("itemPrice");
const itemQty = document.getElementById("itemQty");
const addBtn = document.getElementById("addBtn");
const clearBtn = document.getElementById("clearBtn");
const nowStr = () => new Date().toLocaleString('en-GB').replace(',','');
timeIn.value = nowStr(); timeOut.value = nowStr();
timeInLabel.textContent = nowStr(); timeOutLabel.textContent = nowStr();
new QRious({element:document.getElementById("qrImg"),value:'https://www.papadumsindiancuisine.com',size:80});

let products = [], items = [], unsubscribe = null, syncTimer = null;
function fmt(x){return (x||0).toLocaleString();}
function showSync(){syncing.style.display="block";clearTimeout(syncTimer);syncTimer=setTimeout(()=>syncing.style.display="none",1000);}
function renderItems(newItems){
 itemsList.innerHTML='<div class="row header"><div>Item Name</div><div class="right">Price</div><div class="right">Qty</div><div class="right">Amount</div></div>';
 let total=0;
 newItems.forEach(it=>{
   const r=document.createElement('div');
   r.className='row';
   r.innerHTML=`<div>${it.name}</div><div class="right">${fmt(it.price)}</div><div class="right">${it.qty}</div><div class="right">${fmt(it.price*it.qty)}</div>`;
   itemsList.appendChild(r);
   total+=it.price*it.qty;
 });
 const d=parseFloat(discount.value)||0, v=parseFloat(vatPercent.value)||0;
 const vatAmt=Math.round((total-d)*v/100), grand=total-d+vatAmt;
 totalPrice.textContent=fmt(total); discountLabel.textContent=fmt(d);
 vatPctLabel.textContent=v; vatAmount.textContent=fmt(vatAmt); grandTotal.textContent=fmt(grand);
}

// Load only tables with orders
async function populateTablesWithOrders(){
 tableDashboard.innerHTML = ""; tableSelect.innerHTML = "";
 const snap = await getDocs(collection(db,"tables"));
 snap.forEach(docSnap=>{
   const data = docSnap.data();
   if(data.items && data.items.length>0){
     const t = docSnap.id;
     // Dropdown
     const o = document.createElement("option"); o.value=t; o.textContent=t; tableSelect.appendChild(o);
     // Dashboard button
     const btn = document.createElement("button"); btn.textContent=t;
     btn.onclick=()=>{ tableSelect.value=t; tableLabel.textContent=t; loadTableData(t); };
     tableDashboard.appendChild(btn);
   }
 });
}

// Load table data in real-time
async function loadTableData(table){
 if(unsubscribe) unsubscribe();
 const ref = doc(db,"tables",table);
 unsubscribe = onSnapshot(ref, snap=>{
   const data = snap.data() || {items:[]};
   items = data.items;
   renderItems(items);
   showSync();
 });
}

// Save items to Firestore
async function saveToFirestore(){
 const table = tableSelect.value;
 if(!table) return;
 showSync();
 await setDoc(doc(db,"tables",table), {items});
 await populateTablesWithOrders();
}

// Add item
addBtn.onclick=()=>{
 const n=productSearch.value.trim(), p=parseFloat(itemPrice.value)||0, q=parseInt(itemQty.value)||1;
 if(!n||p<=0) return alert("Enter valid product");
 const f = items.find(i=>i.name===n);
 if(f) f.qty+=q; else items.push({name:n,price:p,qty:q});
 renderItems(items); saveToFirestore();
 productSearch.value=""; itemPrice.value=""; itemQty.value=1;
}

// Clear table
clearBtn.onclick=async()=>{
 if(!confirm("Clear all items for this table?")) return;
 items=[]; renderItems(items); await saveToFirestore();
}

// Table select change
tableSelect.addEventListener("change", e=>{ const t=e.target.value; tableLabel.textContent=t; if(t) loadTableData(t); });

// Load products (replace path with your products.json)
async function loadProducts() {
  const res = await fetch("https://raw.githubusercontent.com/buildawesomesites-creator/invoiceapp/main/products.json");
  products = await res.json();
}

// Initialize
populateTablesWithOrders();
loadProducts();
</script>
</body>
</html>
